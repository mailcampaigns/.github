name: PR merged -> Slack summary

on:
  workflow_call:
    secrets:
      SLACK_WEBHOOK_URL:
        required: false
      OPENAI_API_KEY:
        required: false
    inputs:
      pull_request_number:
        required: true
        type: number
      slack_channel_hint:
        required: false
        type: string
      model:
        required: false
        type: string
        default: "gpt-4.1-mini"

permissions:
  contents: read
  pull-requests: read

jobs:
  summarize:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        id: secret_check
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ] || [ -z "$OPENAI_API_KEY" ]; then
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "Slack/OpenAI secrets missing; skipping." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          echo "enabled=true" >> $GITHUB_OUTPUT

      - name: Collect PR data
        id: pr
        if: ${{ steps.secret_check.outputs.enabled == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo

            const pullNumber = Number('${{ inputs.pull_request_number }}')
            if (!pullNumber || Number.isNaN(pullNumber)) {
              core.setFailed('Missing/invalid inputs.pull_request_number')
              return
            }

            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: pullNumber,
            })

            // fetch changed files (max 100)
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner, repo, pull_number: pullNumber, per_page: 100
            })

            // keep it compact
            const fileNames = files.map(f => f.filename).slice(0, 30)

            core.setOutput("title", pr.title || "")
            core.setOutput("body", pr.body || "")
            core.setOutput("url", pr.html_url || "")
            core.setOutput("number", String(pr.number))
            core.setOutput("author", pr.user?.login || "")
            core.setOutput("additions", String(pr.additions || 0))
            core.setOutput("deletions", String(pr.deletions || 0))
            core.setOutput("changed_files", String(pr.changed_files || files.length || 0))
            core.setOutput("files", JSON.stringify(fileNames))
            core.setOutput("merged", String(Boolean(pr.merged)))

      - name: Generate summary (OpenAI)
        id: ai
        if: ${{ steps.secret_check.outputs.enabled == 'true' && steps.pr.outputs.merged == 'true' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODEL: ${{ inputs.model }}
          TITLE: ${{ steps.pr.outputs.title }}
          BODY: ${{ steps.pr.outputs.body }}
          FILES: ${{ steps.pr.outputs.files }}
          ADDITIONS: ${{ steps.pr.outputs.additions }}
          DELETIONS: ${{ steps.pr.outputs.deletions }}
          CHANGED_FILES: ${{ steps.pr.outputs.changed_files }}
        run: |
          PROMPT=$(jq -n \
            --arg title "$TITLE" \
            --arg body "$BODY" \
            --arg files "$FILES" \
            --arg changed_files "$CHANGED_FILES" \
            --arg additions "$ADDITIONS" \
            --arg deletions "$DELETIONS" \
            '"Je schrijft een superkorte Slack-samenvatting in het Nederlands, niet-technisch.\nMaximaal twee zinnen.\nMOET bevatten: Aanpassing, Waarom, Waar\nGebruik emojis om duidelijker te maken in wat voor categorie het valt. Bijvoorbeeld een üêõ voor een bugfix en üé® voor styling.\n\nContext:\n- Title: \($title)\n- Description: \($body)\n- Files (top): \($files)\n- Stats: \($changed_files) files, +\($additions)/-\($deletions)\n- ...\n"')

          # Call OpenAI Responses API
          RESP=$(curl -s https://api.openai.com/v1/responses \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg model "$MODEL" --arg input "$PROMPT" '{
              model: $model,
              input: $input
            }')")

          TEXT=$(echo "$RESP" | jq -r '.output[0].content[0].text // empty')
          if [ -z "$TEXT" ]; then
            TEXT="Aanpassing:\n- PR gemerged, maar samenvatting faalde.\nWaarom:\n- n.v.t.\nWaar:\n- n.v.t.\nImpact/risico‚Äôs:\n- Check PR handmatig."
          fi

          echo "text<<EOF" >> $GITHUB_OUTPUT
          echo "$TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post to Slack
        if: ${{ steps.secret_check.outputs.enabled == 'true' && steps.pr.outputs.merged == 'true' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PR_URL: ${{ steps.pr.outputs.url }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          SUMMARY: ${{ steps.ai.outputs.text }}
        run: |
          PAYLOAD=$(jq -n \
            --arg title "PR #$PR_NUMBER ‚Äî $PR_TITLE" \
            --arg url "$PR_URL" \
            --arg summary "$SUMMARY" \
            '{
              "blocks": [
                { "type": "section", "text": { "type": "mrkdwn", "text": ("\n<" + $url + "|Bekijk changes>") } },
                { "type": "section", "text": { "type": "mrkdwn", "text": $summary } }
              ]
            }')
          curl -s -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" >/dev/null
